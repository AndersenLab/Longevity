---
title: "Analysis of Longevity"
author: "Ryan Abdella"
date: "January 15, 2015"
output:
  html_document:
    css: ~/Github/Food-Optimization/Scripts/Food_Optimization/Scripts/foghorn_edited.css
---


```{r, warning = F, message = F, echo = F}

library("plyr")
library("dplyr")
library("ggplot2")

experiment <- paste("p0", j, "_", k, "mgmL", sep = "")
data.loc <- paste("../Data/Raw/", experiment, "/", sep = "")
source("./wMT_fxns.R")
source(paste("./", experiment, ".R", sep = ""))

paste(experiment)

```
 

```{r, warning = F, message = F, echo = F}

files <- dir(path = data.loc, plateID, full.names = T)
raw.df <- ldply(files, processMicrotrackerReport) %>% filter(time < num_bins * 2 + 1)
raw.df$day <- rep(1:(length(files)), each = nstrains * replicates * num_bins)

save(raw.df, file = paste(data.loc, "/", experiment, "_Raw.Rda", sep = ""), ascii = TRUE)

```

## Raw Activity

```{r Raw, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(raw.df) + aes(x = day, y = activity) + geom_point() + facet_grid(row ~ col) +
  labs(x = "Time (day)", y = "Activity", title = "Raw Activity Over Time")

```


```{r, warning = F, message = F, echo = F}

data.df <- raw.df[order(raw.df$col, raw.df$row, raw.df$day), ]

data.df$strain <- factor(data.df$col, labels = strains)

save(data.df, file = paste(data.loc, "/", experiment, "_Processed.Rda", sep = ""), ascii = TRUE)

```


```{r, warning = F, message = F, echo = F}

cleaned.df <- data.df
cleaned.df$activity[(data.df$col %in% colRemove)] <- NA

save(cleaned.df, file = paste(data.loc, "/", experiment, "_Cleaned.Rda", sep = ""), ascii = TRUE)

```


```{r, warning = F, message = F, echo = F}

well_normalized.df <- cleaned.df %>%
  group_by(col, row) %>%
  mutate(norm.act = 100 * activity / max(activity, na.rm = TRUE))

cleaned.df <- ungroup(cleaned.df)

save(well_normalized.df, file = paste(data.loc, "/", experiment, "_Well_Normalized.Rda", sep = ""), ascii = TRUE)

```

## Well Normalized Data

```{r Well_Normalized, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(well_normalized.df) + aes(x = factor(day), y = norm.act) + ylim(0, 100) + geom_boxplot() + facet_grid(row ~ strain) +
  labs(x= "Time (day)", y = "Activity")

```


```{r, warning = F, message = F, echo = F}

combined.df <- well_normalized.df
combined.df <- combined.df %>%
  group_by(strain, row, day) %>%
  summarize(activity = sum(activity))
combined.df <- ungroup(combined.df)
combined.df <- combined.df %>%
  group_by(strain, row) %>%
  mutate(norm.act = 100 * activity / max(activity, na.rm = TRUE))

save(combined.df, file = paste(data.loc, "/", experiment, "_Combined.Rda", sep = ""), ascii = TRUE)

```

## Combined Data

```{r Combined, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(combined.df) + aes(x = day, y = norm.act) + ylim(0, 100) + geom_line() + facet_grid(row ~ strain) +
  labs(x = "Time (day)", y = "Activity")

```


```{r, warning = F, message = F, echo = F}

strain_normalized.df <- cleaned.df %>%
  group_by(strain) %>%
  mutate(norm.act = 100 * activity / max(activity, na.rm = TRUE))

cleaned.df <- ungroup(cleaned.df)

save(strain_normalized.df, file = paste(data.loc, "/", experiment, "_Strain_Normalized.Rda", sep = ""), ascii = TRUE)

```

## Strain Normalized Data

```{r Strain_Normalized, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(strain_normalized.df) + aes(x = factor(day), y = norm.act) + ylim(0, 100) + geom_boxplot() + facet_wrap( ~ strain) + 
  labs(x = "Time (day)", y = "Activity")

```


```{r, warning = F, message = F, echo = F}

summary.df <- well_normalized.df
summary.df <- summary.df %>%
  group_by(strain, day) %>%
  summarize(activity = sum(activity))
summary.df <- ungroup(summary.df)
summary.df <- summary.df %>%
  group_by(strain) %>%
  mutate(norm.act = 100 * activity / max(activity, na.rm = TRUE))

save(summary.df, file = paste(data.loc, "/", experiment, "_Summary.Rda", sep = ""), ascii = TRUE)

```

## Summary Data

```{r Summary, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(summary.df) + aes(x = day, y = norm.act) + ylim(0, 100) + geom_line() + facet_wrap( ~ strain) +
  labs(x = "Time (day)", y = "Activity")

```

## Plate Distribution

```{r Plate_Dist, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(normalized.df) + aes(x = factor(day), y = norm.act) + ylim(0, 100) + geom_boxplot() + labs(x = "Time (day)", y = "Activity")

```


```{r, warning = F, message = F, echo = F}

plate.df <- cleaned.df 
plate.df <- plate.df %>%
  group_by(day) %>% 
  summarize(total = sum(activity, na.rm = TRUE))
plate.df <- ungroup(plate.df)
plate.df <- plate.df %>%
  mutate(norm.act = 100 * total / max(total, na.rm = TRUE))

save(plate.df, file = paste(data.loc, "/", experiment, "_Plate.Rda", sep = ""), ascii = TRUE)

```

## Plate Data

```{r Plate, warning = F, message = F, echo = F, fig.path = paste("Scripts/", data.loc, "/", experiment, "_", sep = ""), fig.width = 15, fig.height = 12}

ggplot(plate.df) + aes(x = day, y= norm.act) + geom_line() + ylim(0, 100) + labs(x = "Time (day)", y = "Activity")

```

## Curve Fitting

```{r, warning = F, message = F, echo = F}

well_gompertz <- function(input, df, row, strain) {
  sum(((100 * 100 ^ ((input[1] / input[2]) * (1 - exp(input[2] * df$day[df$row == row & df$strain == strain])))) - df$norm.act[df$row == row & df$strain == strain]) ^ 2)
}

strain_gompertz <- function(input, df, strain) {
  sum(((100 * 100 ^ ((input[1] / input[2]) * (1 - exp(input[2] * df$day[df$strain == strain])))) - df$norm.act[df$strain == strain]) ^ 2)
}

well_weibull <- function(input, df, row, strain) {
  sum(((100 * 100 ^ (-((df$day[df$row == row & df$strain == strain] / input[2]) ^ input[1]))) - df$norm.act[df$row == row & df$strain == strain]) ^ 2)
}

strain_weibull <- function(input, df, strain) {
  sum(((100 * 100 ^ (-((df$day[df$strain == strain] / input[2]) ^ input[1]))) - df$norm.act[df$strain == strain]) ^ 2)
}

well_twoplog <- function(input, df, row, strain) {
  sum(((100 / (1 + ((df$day[df$row == row & df$strain == strain] / input[2]) ^ input[1]))) - df$norm.act[df$row == row & df$strain == strain]) ^ 2)
}

strain_twoplog <- function(input, df, strain) {
  sum(((100 / (1 + ((df$day[df$strain == strain] / input[2]) ^ input[1]))) - df$norm.act[df$strain == strain]) ^ 2)
}

well_threeplog <- function(input, df, row, strain) {
  sum(((100 * 100 ^ (-input[2] * df$day[df$row == row & df$strain == strain] - (input[2] / input[3]) * ln((input[1] - (input[2] - input[1]) * exp(-input[3] * df$day[df$row == row & df$strain == strain])) / input[2]))) - df$norm.act[df$row == row & df$strain == strain]) ^ 2)
}

strain_threeplog <- function(input, df, strain) {
  sum(((100 * 100 ^ (-input[2] * df$day[df$strain == strain] - (input[2] / input[3]) * ln((input[1] - (input[2] - input[1]) * exp(-input[3] * df$day[df$strain == strain])) / input[2]))) - df$norm.act[df$strain == strain]) ^ 2)
}

twoplog2 <- formula(norm.act ~ 100/(1 + ((day / b) ^ c)))

well_params.df <- data.frame(strain = rep(levels(factor(combined.df$strain)), each = length(levels(factor(combined.df$row)))), row = rep(levels(factor(combined.df$row)), length(levels(factor(combined.df$strain)))), bparam = rep(0, length(strains) * replicates), cparam = rep(0, length(strains) * replicates))

l = 1

for (x in levels(factor(combined.df$strain))) {
  for (y in levels(factor(combined.df$row))) {
    if (!(is.na(combined.df$norm.act[combined.df$row == y & combined.df$strain == x]))[1] == TRUE) {
      temp <- nlm(well_twoplog, c(2, 2), combined.df, y, x)[["estimate"]]
      well_params.df$bparam[l] <- temp[1]
      well_params.df$cparam[l] <- temp[2]
      }
    l = l + 1
    }
  }

save(well_params.df, file = paste(data.loc, "/", experiment, "_Well_Params.Rda", sep = ""), ascii = TRUE)

print(well_params.df)

strain_params.df <- data.frame(strain = levels(factor(combined.df$strain)), bparam = rep(0, length(strains)), cparam = rep(0, length(strains)))

l = 1

for (x in levels(factor(combined.df$strain))) {
  if(!(is.na(summary.df$norm.act[summary.df$strain == x]))[1] == TRUE) {
    temp <- nlm(strain_twoplog, c(2, 2), summary.df, x)[["estimate"]]
    strain_params.df$bparam[l] <- temp[1]
    strain_params.df$cparam[l] <- temp[2]
  }
  l = l + 1
}

save(strain_params.df, file = paste(data.loc, "/", experiment, "_Strain_Params.Rda", sep = ""), ascii = TRUE)

print(strain_params.df)

```