---
title: "Well_Statistics"
author: "Ryan Abdella"
date: "3 March 2015"
output: html_document
---

```{r, warning = FALSE, message = FALSE, echo = FALSE, fig.width = 15, fig.height = 12}

library("knitr")
library("stringr")
library("plyr")
library("dplyr")
library("ggplot2")
library("tidyr")

source("./Scripts/survival_fxns.R")
experimentName <- "p04_3mgmL"
source(paste("./Scripts/", experimentName, ".R", sep = ""))
processedDataPath <- paste("./Data/Processed/", experimentName, sep = "")
saveDataLocation <- paste(processedDataPath, "/", experimentName, sep = "")

load(paste("./Data/Processed/", experimentName, "/", experimentName, "_Well.Rda", sep = ""))
well.df <- well.df[-ncol(well.df)]

well.df <- well.df %>%
  group_by(col, row) %>%
  mutate(norm.activity = 100 * activity / max(activity, na.rm = TRUE))
well.df <- ungroup(well.df)

ggplot(well.df) + aes(x = day, y = activity) + geom_line() + facet_grid(row ~ uniqueStrain) + presentation

```

```{r, warning = FALSE, message = FALSE, echo = FALSE, fig.width = 15, fig.height = 12}

## Let's group the wells into pairs and perform curve fitting. ##

files <- dir(path = paste("./Data/Raw/", experimentName, sep = ""), 
             pattern = ".txt", 
             full.names = TRUE)
nFiles <- length(files)

well.df$grouping <- rep(rep(1:4, each = nFiles * 2), 12)

well_twos.df <- well.df %>%
  group_by(col, strain, uniqueStrain, grouping, day) %>%
  summarise(activity = mean(activity, na.rm = TRUE))
well_twos.df <- ungroup(well_twos.df)

well_twos.df <- well_twos.df %>%
  group_by(col, grouping) %>%
  mutate(norm.activity = 100 * activity / max(activity, na.rm = TRUE))
well_twos.df <- ungroup(well_twos.df)

for (i in 1:nrow(well_twos.df)) {
  if (!is.finite(well_twos.df$activity[i])) well_twos.df$activity[i] <- NA
  if (!is.finite(well_twos.df$norm.activity[i])) well_twos.df$norm.activity[i] <- NA
}

ggplot(well_twos.df) + aes(x = day, y = activity) + geom_line() + facet_grid(grouping ~ uniqueStrain) + presentation

```

```{r, warning = FALSE, message = FALSE, echo = FALSE, fig.width = 15, fig.height = 12}

well.df$grouping <- rep(rep(c(1, 1, 1, 2, 2, 2, 3, 3), each = nFiles), 12)

well_threes.df <- well.df %>%
  group_by(col, strain, uniqueStrain, grouping, day) %>%
  summarise(activity = mean(activity, na.rm = TRUE))
well_threes.df <- ungroup(well_threes.df)

well_threes.df <- well_threes.df %>%
  group_by(col, grouping) %>%
  mutate(norm.activity = 100 * activity / max(activity, na.rm = TRUE))
well_threes.df <- ungroup(well_threes.df)

for (i in 1:nrow(well_threes.df)) {
  if (!is.finite(well_threes.df$activity[i])) well_threes.df$activity[i] <- NA
  if (!is.finite(well_threes.df$norm.activity[i])) well_threes.df$norm.activity[i] <- NA
}

ggplot(well_threes.df) + aes(x = day, y = activity) + geom_line() + facet_grid(grouping ~ uniqueStrain) + presentation

```

```{r, warning = FALSE, message = FALSE, echo = FALSE, fig.width = 15, fig.height = 12}

well.df$grouping <- rep(rep(1:2, each = nFiles * 4), 12)

well_fours.df <- well.df %>%
  group_by(col, strain, uniqueStrain, grouping, day) %>%
  summarise(activity = mean(activity, na.rm = TRUE))
well_fours.df <- ungroup(well_fours.df)

well_fours.df <- well_fours.df %>%
  group_by(col, grouping) %>%
  mutate(norm.activity = 100 * activity / max(activity, na.rm = TRUE))
well_fours.df <- ungroup(well_fours.df)

for (i in 1:nrow(well_fours.df)) {
  if (!is.finite(well_fours.df$activity[i])) well_fours.df$activity[i] <- NA
  if (!is.finite(well_fours.df$norm.activity[i])) well_fours.df$norm.activity[i] <- NA
}

ggplot(well_fours.df) + aes(x = day, y = activity) + geom_line() + facet_grid(grouping ~ uniqueStrain) + presentation

```

```{r, warning = FALSE, message = FALSE, echo = FALSE, fig.width = 15, fig.height = 12}

strain.df <- well.df %>%
  group_by(col, strain, uniqueStrain, day) %>%
  summarise(activity = mean(activity, na.rm = TRUE))
strain.df <- ungroup(strain.df)

strain.df <- strain.df %>%
  group_by(col) %>%
  mutate(norm.activity = 100 * activity / max(activity, na.rm = TRUE))
strain.df <- ungroup(strain.df)

for (i in 1:nrow(strain.df)) {
  if (!is.finite(strain.df$activity[i])) strain.df$activity[i] <- NA
  if (!is.finite(strain.df$norm.activity[i])) strain.df$norm.activity[i] <- NA
}

ggplot(strain.df) + aes(x = day, y = activity) + geom_line() + facet_wrap( ~ uniqueStrain) + presentation

```

```{r, warning = FALSE, message = FALSE, echo = FALSE}

well_params.df <- data.frame(col = rep(1:12, each = length(rows)), row = rep(rows, nStrains), bparam = rep(0, nStrains * replicates), cparam = rep(0, nStrains * replicates))

l = 1

for (x in 1:12) {
  for (y in rows) {
    if (!(is.na(well.df$norm.activity[well.df$row == y & well.df$col == x]))[1] == TRUE) {
      temp <- nlm(well_twoplog, c(2, 1), well.df, y, x)[["estimate"]]
      well_params.df$bparam[l] <- temp[1]
      well_params.df$cparam[l] <- temp[2]
    }
    l = l + 1
  }
}

```

```{r, warning = FALSE, message = FALSE, echo = FALSE}

well_twos_params.df <- data.frame(col = rep(1:12, each = 4), grouping = rep(1:4, nStrains), bparam = rep(0, nStrains * 4), cparam = rep(0, nStrains * 4))

l = 1

for (x in 1:12) {
  for (y in 1:4) {
    if (!(is.na(well_twos.df$norm.activity[well_twos.df$grouping == y & well_twos.df$col == x]))[1] == TRUE) {
      temp <- nlm(well_twoplog_grouping, c(2, 1), well_twos.df, y, x)[["estimate"]]
      well_twos_params.df$bparam[l] <- temp[1]
      well_twos_params.df$cparam[l] <- temp[2]
    }
    l = l + 1
  }
}

```

```{r, warning = FALSE, message = FALSE, echo = FALSE}

well_threes_params.df <- data.frame(col = rep(1:12, each = 3), grouping = rep(1:3, nStrains), bparam = rep(0, nStrains * 3), cparam = rep(0, nStrains * 3))

l = 1

for (x in 1:12) {
  for (y in 1:3) {
    if (!(is.na(well_threes.df$norm.activity[well_threes.df$grouping == y & well_threes.df$col == x]))[1] == TRUE) {
      temp <- nlm(well_twoplog_grouping, c(2, 1), well_threes.df, y, x)[["estimate"]]
      well_threes_params.df$bparam[l] <- temp[1]
      well_threes_params.df$cparam[l] <- temp[2]
    }
    l = l + 1
  }
}

```

```{r, warning = FALSE, message = FALSE, echo = FALSE}

well_fours_params.df <- data.frame(col = rep(1:12, each = 2), grouping = rep(1:2, nStrains), bparam = rep(0, nStrains * 2), cparam = rep(0, nStrains * 2))

l = 1

for (x in 1:12) {
  for (y in 1:2) {
    if (!(is.na(well_fours.df$norm.activity[well_fours.df$grouping == y & well_fours.df$col == x]))[1] == TRUE) {
      temp <- nlm(well_twoplog_grouping, c(2, 1), well_fours.df, y, x)[["estimate"]]
      well_fours_params.df$bparam[l] <- temp[1]
      well_fours_params.df$cparam[l] <- temp[2]
    }
    l = l + 1
  }
}

```

```{r, warning = FALSE, message = FALSE, echo = FALSE}

strain_params.df <- data.frame(col = rep(1:12), bparam = rep(0, nStrains), cparam = rep(0, nStrains))

l = 1

for (x in uniqueStrains) {
  if (!(is.na(strain.df$norm.activity[strain.df$uniqueStrain == x]))[1] == TRUE) {
    temp <- nlm(strain_twoplog, c(2, 1), strain.df, x)[["estimate"]]
    strain_params.df$bparam[l] <- temp[1]
    strain_params.df$cparam[l] <- temp[2]
  }
  l = l + 1
}

```

```{r, warning = FALSE, message = FALSE, echo = FALSE, results = "asis"}

kable(well_params.df)
kable(well_twos_params.df)
kable(well_threes_params.df)
kable(well_fours_params.df)
kable(strain_params.df)

```
